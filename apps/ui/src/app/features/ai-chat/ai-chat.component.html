<div class="ai-chat-container">
  <!-- Header -->
  <div class="chat-header">
    <div class="header-content">
      <div class="ai-info">
        <nz-icon nzType="robot" class="ai-icon"></nz-icon>
        <div class="ai-details">
          <h2>BlueLedger AI ★</h2>
          <p>Your intelligent assistant for miniERP</p>
        </div>
      </div>
      <div class="conversation-info" *ngIf="conversationId()">
        <span class="conversation-id">Session: {{ conversationId()?.substring(0, 8) }}...</span>
      </div>
    </div>
  </div>

  <!-- Messages Area -->
  <div class="messages-container">
    <div class="messages-list" #messagesContainer>
      <div 
        *ngFor="let message of messages(); trackBy: trackByMessage" 
        class="message-item"
        [class.user-message]="message.role === 'user'"
        [class.assistant-message]="message.role === 'assistant'"
      >
        <div class="message-content">
          <div class="message-header">
            <span class="message-role">
              <nz-icon 
                [nzType]="message.role === 'user' ? 'user' : 'robot'" 
                class="role-icon"
              ></nz-icon>
              {{ message.role === 'user' ? 'You' : 'BlueLedger AI ★' }}
            </span>
            <span class="message-time">{{ formatTimestamp(message.timestamp) }}</span>
          </div>
          
          <div class="message-text" [innerHTML]="formatMessageContent(message.content)"></div>
          
          <!-- Tool Data Rendering -->
          <div *ngIf="message.toolData" class="tool-data">
            <ng-container [ngSwitch]="message.toolData.type">
              <!-- Products Table -->
              <div *ngSwitchCase="'products'" class="products-table">
                <h4>Products Found ({{ message.toolData.count }})</h4>
                <ag-grid-angular
                  class="ag-theme-alpine enterprise-grid"
                  [rowData]="message.toolData.data"
                  [columnDefs]="getProductColumns()"
                  [defaultColDef]="defaultColDef"
                  [domLayout]="'autoHeight'"
                  [suppressRowClickSelection]="true"
                  [rowHeight]="40">
                </ag-grid-angular>
              </div>
              
              <!-- Clients Table -->
              <div *ngSwitchCase="'clients'" class="clients-table">
                <h4>Clients Found ({{ message.toolData.count }})</h4>
                <ag-grid-angular
                  class="ag-theme-alpine enterprise-grid"
                  [rowData]="message.toolData.data"
                  [columnDefs]="getClientColumns()"
                  [defaultColDef]="defaultColDef"
                  [domLayout]="'autoHeight'"
                  [suppressRowClickSelection]="true"
                  [rowHeight]="40">
                </ag-grid-angular>
              </div>
              
              <!-- Order Stats -->
              <div *ngSwitchCase="'order_stats'" class="order-stats">
                <h4>Order Statistics</h4>
                <div class="stats-summary">
                  <div class="stat-item">
                    <span class="stat-label">Total Orders:</span>
                    <span class="stat-value">{{ message.toolData.totals.totalOrders }}</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Total Amount:</span>
                    <span class="stat-value">{{ message.toolData.totals.totalAmount | currency:'BAM':'symbol':'1.2-2' }}</span>
                  </div>
                </div>
                <ag-grid-angular
                  class="ag-theme-alpine enterprise-grid"
                  [rowData]="message.toolData.data"
                  [columnDefs]="getOrderStatsColumns()"
                  [defaultColDef]="defaultColDef"
                  [domLayout]="'autoHeight'"
                  [suppressRowClickSelection]="true"
                  [rowHeight]="40">
                </ag-grid-angular>
              </div>
              
              <!-- User Preferences -->
              <div *ngSwitchCase="'user_preferences'" class="user-preferences">
                <h4>Current User Preferences</h4>
                <div class="preferences-grid">
                  <div class="preference-item" *ngFor="let pref of getPreferencesList(message.toolData.data)">
                    <span class="preference-label">{{ pref.label }}:</span>
                    <span class="preference-value">{{ pref.value }}</span>
                  </div>
                </div>
              </div>
              
              <!-- Cart Update -->
              <div *ngSwitchCase="'cart_update'" class="cart-update">
                <h4>Cart Updated</h4>
                <p>{{ message.toolData.message }}</p>
                <div class="cart-summary">
                  <div class="cart-item" *ngFor="let item of message.toolData.data.items">
                    <span class="item-name">{{ item.product.name }}</span>
                    <span class="item-quantity">Qty: {{ item.quantity }}</span>
                    <span class="item-price">{{ item.totalPrice | currency:'BAM':'symbol':'1.2-2' }}</span>
                  </div>
                  <div class="cart-total">
                    <strong>Total: {{ message.toolData.data.grandTotal | currency:'BAM':'symbol':'1.2-2' }}</strong>
                  </div>
                </div>
              </div>
              
              <!-- Order Created -->
              <div *ngSwitchCase="'order_created'" class="order-created">
                <h4>Order Created Successfully</h4>
                <p>{{ message.toolData.message }}</p>
                <div class="order-details">
                  <div class="order-item" *ngFor="let item of message.toolData.data.items">
                    <span class="item-name">{{ item.product.name }}</span>
                    <span class="item-quantity">Qty: {{ item.quantity }}</span>
                    <span class="item-price">{{ item.totalPrice | currency:'BAM':'symbol':'1.2-2' }}</span>
                  </div>
                  <div class="order-total">
                    <strong>Total: {{ message.toolData.data.grandTotal | currency:'BAM':'symbol':'1.2-2' }}</strong>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
      
      <!-- Loading indicator -->
      <div *ngIf="loading()" class="message-item assistant-message">
        <div class="message-content">
          <div class="message-header">
            <span class="message-role">
              <nz-icon nzType="robot" class="role-icon"></nz-icon>
              BlueLedger AI ★
            </span>
          </div>
          <div class="message-text">
            <nz-spin nzSize="small"></nz-spin>
            <span class="loading-text">Thinking...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Input Area -->
  <div class="input-container">
    <div class="input-wrapper">
      <textarea
        nz-input
        [(ngModel)]="userInput"
        (keypress)="onKeyPress($event)"
        placeholder="Ask me anything about your miniERP system..."
        class="message-input"
        [disabled]="loading()"
        rows="1"
        #messageInput
      ></textarea>
      <button
        nz-button
        nzType="primary"
        [nzLoading]="loading()"
        [disabled]="!userInput().trim() || loading()"
        (click)="sendMessage()"
        class="send-button"
      >
        <nz-icon nzType="send"></nz-icon>
      </button>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <nz-modal
    [(nzVisible)]="isModalVisible"
    [nzTitle]="getActionTitle(proposedAction()?.action || '')"
    [nzContent]="modalContent"
    [nzFooter]="modalFooter"
    (nzOnCancel)="cancelAction()"
    nzWidth="600px"
  >
    <ng-template #modalContent>
      <div class="confirmation-content" *ngIf="proposedAction()">
        <div class="action-summary">
          <nz-icon [nzType]="getActionIcon(proposedAction()!.action)" class="action-icon"></nz-icon>
          <h3>{{ proposedAction()!.summary }}</h3>
        </div>
        
        <div class="action-details">
          <h4>Action Details:</h4>
          <pre class="action-args">{{ proposedAction()!.args | json }}</pre>
        </div>
        
        <div class="confirmation-warning">
          <nz-icon nzType="exclamation-circle" class="warning-icon"></nz-icon>
          <p>Please review the details above before confirming this action.</p>
        </div>
      </div>
    </ng-template>

    <ng-template #modalFooter>
      <div class="modal-footer">
        <button nz-button (click)="cancelAction()">Cancel</button>
        <button 
          nz-button 
          nzType="primary" 
          [nzLoading]="loading()"
          (click)="confirmAction()"
        >
          Confirm Action
        </button>
      </div>
    </ng-template>
  </nz-modal>
</div>
