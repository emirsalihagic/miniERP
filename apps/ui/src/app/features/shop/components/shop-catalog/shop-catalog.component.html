<div class="shop-catalog">
  <!-- Header with cart badge -->
  <div class="catalog-header">
    <h1>Shop Products</h1>
    <div class="cart-info">
      <nz-badge [nzCount]="cartItemCount" [nzShowZero]="false">
        <button type="button" class="btn btn-primary" routerLink="/shop/cart">
          <span nz-icon nzType="shopping-cart"></span>
          Cart
        </button>
      </nz-badge>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div nz-row [nzGutter]="[16, 16]">
      <div nz-col nzXs="24" nzSm="12" nzMd="8">
        <nz-input-group nzPrefixIcon="search">
          <input 
            nz-input 
            placeholder="Search products..." 
            [(ngModel)]="searchTerm"
            (keyup.enter)="onSearch()"
          />
        </nz-input-group>
      </div>
      <div nz-col nzXs="24" nzSm="12" nzMd="8">
        <nz-select 
          nzPlaceHolder="Filter by brand" 
          [(ngModel)]="selectedBrand"
          (ngModelChange)="onFilterChange()"
          nzAllowClear
        >
          <nz-option *ngFor="let brand of brands" [nzValue]="brand" [nzLabel]="brand"></nz-option>
        </nz-select>
      </div>
      <div nz-col nzXs="24" nzSm="12" nzMd="8">
        <nz-select 
          nzPlaceHolder="Filter by category" 
          [(ngModel)]="selectedGroup"
          (ngModelChange)="onFilterChange()"
          nzAllowClear
        >
          <nz-option *ngFor="let group of groups" [nzValue]="group.id" [nzLabel]="group.name"></nz-option>
        </nz-select>
      </div>
    </div>
  </div>

  <!-- Products Grid -->
  <div class="products-section">
    <nz-spin [nzSpinning]="loading">
      <div nz-row [nzGutter]="[16, 16]" *ngIf="groupedProducts.length > 0">
        <div nz-col nzXs="24" nzSm="12" nzMd="8" nzLg="6" *ngFor="let groupedProduct of groupedProducts">
          <nz-card 
            [nzHoverable]="true" 
            class="product-card"
            [nzBodyStyle]="{ padding: '16px' }"
          >
            <div class="product-image">
              <img 
                [src]="getProductImage(groupedProduct)" 
                [alt]="groupedProduct.baseName"
                class="product-img"
              />
            </div>
            
            <div class="product-info">
              <h3 class="product-name">{{ groupedProduct.baseName }}</h3>
              
              <!-- Variant Selection -->
              <div class="variant-selection" *ngIf="groupedProduct.variants.length > 1">
                <nz-select 
                  [ngModel]="groupedProduct.selectedVariant.id"
                  (ngModelChange)="onVariantChange(groupedProduct, $event)"
                  nzSize="small"
                  style="width: 100%; margin-bottom: 8px;"
                >
                  <nz-option 
                    *ngFor="let variant of groupedProduct.variants" 
                    [nzValue]="variant.id" 
                    [nzLabel]="getVariantDisplayText(variant)"
                  ></nz-option>
                </nz-select>
              </div>
              
              <p class="product-sku">SKU: {{ groupedProduct.selectedVariant.sku }}</p>
              
              <div class="product-details">
                <div class="product-brand" *ngIf="groupedProduct.brand">
                  <nz-tag nzColor="blue">{{ groupedProduct.brand }}</nz-tag>
                </div>
                
                <div class="product-supplier">
                  <span class="supplier-label">Supplier:</span>
                  <span class="supplier-name">{{ groupedProduct.supplier?.name }}</span>
                </div>
                
                <div class="product-unit" *ngIf="groupedProduct.unit">
                  <span class="unit-label">Unit:</span>
                  <span class="unit-name">{{ groupedProduct.unit.name }} ({{ groupedProduct.unit.code }})</span>
                </div>
              </div>

              <!-- Product Attributes -->
              <div class="product-attributes" *ngIf="hasAttributes(groupedProduct.selectedVariant)">
                <div class="attribute-item" *ngFor="let attr of groupedProduct.selectedVariant.attributes | keyvalue">
                  <span class="attr-name">{{ attr.key }}:</span>
                  <span class="attr-value">{{ attr.value }}</span>
                </div>
              </div>
            </div>

            <div class="product-footer">
              <div class="product-price">
                <span class="price-label">Price:</span>
                <span class="price-value" *ngIf="!isPriceLoading(groupedProduct.selectedVariant.id)">
                  {{ formatPrice(getProductPrice(groupedProduct.selectedVariant)) }} <span class="vat-label">(excl. VAT)</span>
                </span>
                <span class="price-loading" *ngIf="isPriceLoading(groupedProduct.selectedVariant.id)">
                  <nz-spin nzSize="small"></nz-spin>
                </span>
              </div>
              
              <div class="product-actions">
                <div class="quantity-input">
                  <nz-input-number
                    [(ngModel)]="productQuantities[groupedProduct.selectedVariant.id]"
                    [nzMin]="0.1"
                    [nzStep]="0.1"
                    [nzPrecision]="1"
                    nzSize="small"
                    placeholder="Qty"
                    style="width: 80px; margin-right: 8px;"
                  ></nz-input-number>
                </div>
                <button 
                  type="button"
                  class="btn btn-sm btn-primary add-to-cart-btn"
                  (click)="addToCart(groupedProduct)"
                  [disabled]="!productQuantities[groupedProduct.selectedVariant.id] || productQuantities[groupedProduct.selectedVariant.id] <= 0 || isPriceLoading(groupedProduct.selectedVariant.id)"
                >
                  <span nz-icon nzType="plus"></span>
                  Add to Cart
                </button>
              </div>
            </div>
          </nz-card>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!loading && groupedProducts.length === 0" class="empty-state">
        <nz-empty 
          nzNotFoundImage="simple"
          nzNotFoundContent="No products found"
          nzNotFoundFooter="Try adjusting your search or filters"
        ></nz-empty>
      </div>
    </nz-spin>
  </div>

  <!-- Pagination -->
  <div class="pagination-section" *ngIf="total > pageSize">
    <nz-pagination
      [(nzPageIndex)]="page"
      [nzTotal]="total"
      [nzPageSize]="pageSize"
      [nzShowSizeChanger]="false"
      [nzShowQuickJumper]="true"
      (nzPageIndexChange)="onPageChange($event)"
    ></nz-pagination>
  </div>
</div>
